<!-- æµ®åŠ¨æŒ‰é’® -->
<button id="routerBtn" style="position:fixed; top:20px; right:20px; width:50px; height:50px; background:#42b983; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:99999999; font-size:24px; border:none; outline:none;">ğŸ“Š</button>

<!-- è·¯ç”±é¢æ¿ -->
<div id="routerPanel" style="position:fixed; top:0; right:-400px; width:400px; height:100vh; background:#fff; box-shadow:-5px 0 15px rgba(0,0,0,0.05); z-index:99999998; transition:right 0.3s ease; overflow-y:auto; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
  <!-- é¢æ¿å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
</div>

<script>
        // è·å–è·¯ç”±å®ä¾‹
    function router() {
        // åˆå§‹åŒ–å…¨å±€å˜é‡
        if (!window.__mss__) window.__mss__ = {};
        if (!window.__mss__.proxyhook) window.__mss__.proxyhook = {};
        if(document.querySelector("#app").__vue__){
            //vue 2
            window.__mss__.proxyhook.router=document.querySelector("#app").__vue__.$router;
        }else{
            //vue 3
            window.__mss__.proxyhook.router=document.querySelector("#app").__vue_app__.config.globalProperties.$router;
        }
        return window.__mss__.proxyhook.router;
    }


    // æˆ‘è¯´ç²‘ç²‘è¿˜æ˜¯å¾—äººåƒ è¿™æ—¶å€™deråŒ…å¼€å§‹è£…æ­»
    function turtle(node,re,rpath=""){ //é€’å½’ 
        //å†™å¾—å¤´ç–¼è®¨åŒæ­»äº†
        if(node.children===undefined|| node.children===null||node.children.length==0){
            re.push(rpath+node.path);
            return; //å½“æ²¡æœ‰å­èŠ‚ç‚¹çš„æ—¶å€™è¿”å›
        } 
        node.children.forEach(c=>{
            turtle(c,re,rpath+node.path); //å¯¹æ‰€æœ‰å­èŠ‚ç‚¹è°ƒç”¨
        })
    }


    // DOMå…ƒç´ 
    const btn = document.getElementById('routerBtn');
    const panel = document.getElementById('routerPanel');

    let lastPathList = [];
    let refreshIntervalId = null;

    // åˆ‡æ¢é¢æ¿
    btn.addEventListener('click', () => {
        const isOpen = panel.style.right === '0px';
        if (isOpen) {
            panel.style.right = '-400px';
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        } else {
            panel.style.right = '0px';
            fetchAndUpdateRoutes();
            if (!refreshIntervalId) {
                refreshIntervalId = setInterval(fetchAndUpdateRoutes, 1000);
            }
        }
    });

    // è·å–å¹¶æ›´æ–°è·¯ç”±
    function fetchAndUpdateRoutes() {
        try {
            const r = router();
            if (!r || !r.getRoutes) {
                if (panel.innerHTML !== '<div style="padding:20px; color:#999; text-align:center;">æœªè·å–åˆ°è·¯ç”±å®ä¾‹</div>') {
                    panel.innerHTML = '<div style="padding:20px; color:#999; text-align:center;">æœªè·å–åˆ°è·¯ç”±å®ä¾‹</div>';
                }
                return;
            }

            const routes = r.getRoutes();
            const pathList = [];
            routes.forEach(route => turtle(route, pathList));

            if (arraysAreEqual(pathList, lastPathList)) {
                return;
            }

            renderRouterList(pathList);
            lastPathList = [...pathList];

        } catch (e) {
            console.error("åŠ è½½è·¯ç”±å¤±è´¥ï¼š", e);
            if (panel.innerHTML !== '<div style="padding:20px; color:#ff6b6b; text-align:center;">åŠ è½½å¤±è´¥</div>') {
                panel.innerHTML = '<div style="padding:20px; color:#ff6b6b; text-align:center;">åŠ è½½å¤±è´¥</div>';
            }
        }
    }

    // æ¯”è¾ƒæ•°ç»„æ˜¯å¦ç›¸åŒ
    function arraysAreEqual(a, b) {
        if (a.length !== b.length) return false;
        for (let i = 0; i < a.length; i++) {
            if (a[i] !== b[i]) return false;
        }
        return true;
    }
    
    // æ¸²æŸ“è·¯ç”±åˆ—è¡¨ UI
    function renderRouterList(pathList) {
        // ä¼˜åŒ–ï¼šå¤´éƒ¨æ ·å¼
        let html = '<div style="padding:15px 20px; background:#f8f8f8; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0;">';
        html += '<strong style="font-size:16px; color:#333;">è·¯ç”±åˆ—è¡¨</strong>';
        html += '<span id="closeBtn" style="cursor:pointer; font-size:20px; color:#999; transition: color 0.2s;">Ã—</span>';
        html += '</div>';

        if (pathList.length === 0) {
            // ä¼˜åŒ–ï¼šç©ºçŠ¶æ€æ ·å¼
            html += '<div style="padding:40px 20px; color:#999; text-align:center;">æš‚æ— è·¯ç”±æ•°æ®</div>';
        } else {
            pathList.forEach(path => {
                // ä¼˜åŒ–ï¼šè·¯ç”±é¡¹æ ·å¼
                html += `<div class="router-item" style="padding:14px 20px; border-bottom:1px solid #eee; cursor:pointer; transition: all 0.2s; font-size:16px; color:#555; font-weight:500;">${path}</div>`;
            });
        }

        panel.innerHTML = html;
        
        // ä¸ºæ¯ä¸ªè·¯ç”±é¡¹æ·»åŠ  hover äº‹ä»¶
        document.querySelectorAll('.router-item').forEach(item => {
            item.addEventListener('mouseenter', () => {
                item.style.backgroundColor = '#f0f0f0';
                item.style.color = '#333';
            });
            item.addEventListener('mouseleave', () => {
                item.style.backgroundColor = 'transparent';
                item.style.color = '#555';
            });
            item.addEventListener('click', () => {
                navigateTo(item.textContent);
            });
        });

        document.getElementById('closeBtn').addEventListener('click', () => {
            panel.style.right = '-400px';
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        });
    }

    // å¯¼èˆªå‡½æ•°
    function navigateTo(path) {
        const r = router();
        if (r && r.push) {
            r.push(path);
        }
    }
</script>